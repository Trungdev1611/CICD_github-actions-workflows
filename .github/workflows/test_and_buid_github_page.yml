name: Test, Build & Deploy to GitHub Pages

on:
    push:
        branches:
            - main

# Thêm cấu hình concurrency để cancel workflow cũ khi có push mới
concurrency:
    group: test-build-deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test_and_build_react_app:
        runs-on: ubuntu-latest
        
        # Set biến môi trường cho toàn bộ job
        # Ưu tiên: GitHub Variables → fallback về giá trị mặc định
        env:
            VITE_API_URL: ${{ vars.VITE_API_URL || 'https://jsonplaceholder.typicode.com' }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Nodejs
              uses: actions/setup-node@v4
              with:
                node-version: 20
                cache: 'npm'

            - name: Install dependency
              run: npm ci


            - name: run test before build
              run:  |
                npm test
                echo "test passed"

            - name: build app
              run: |
                echo "Building with API URL: $VITE_API_URL"
                npm run build
                echo "build passed"

            - name: Deploy to GitHub Pages
              uses: peaceiris/actions-gh-pages@v3
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                publish_dir: ./dist
                publish_branch: gh-pages
                commit_message: "Deployed by GitHub Actions to Github page - learn it 06/12/2025"
                # Link deploy: https://Trungdev1611.github.io/CICD_github-actions-workflows/
            